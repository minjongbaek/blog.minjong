---
date: "2023-04-19"
title: "Suspense & ErrorBoundaryë¥¼ ì´ìš©í•œ ì„ ì–¸ì  ë Œë”ë§"
tags: ["React", "Next.js"]
description: "Next.jsì—ì„œ Suspense ì‚½ì§ˆ ê¸°ë¡"
---

ìµœê·¼ì— Suspenseë¥¼ ë„ì…í•´ì„œ <a href="/devcourse-final-project-retrospect" target="_blank">ë‹¤ë…ë‹¤ë… í”„ë¡œì íŠ¸</a>ë¥¼ ë¦¬íŒ©í„°ë§í–ˆë‹¤. ê·¸ ê¸°ë¡ì„ ë‚¨ê¸°ë ¤ê³  í•œë‹¤.

## Suspense

**SuspenseëŠ” ë Œë”ë§ ì‹œê°„ì„ ì˜ˆì¸¡í•  ìˆ˜ ì—†ëŠ” ìƒí™©ì— ë” ë‚˜ì€ ì‚¬ìš©ì ê²½í—˜ì„ ì œê³µí•˜ê¸° ìœ„í•´ ì¶”ê°€ëœ ê¸°ëŠ¥ì´ë‹¤.** Suspenseë¥¼ ì‚¬ìš©í•˜ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë™ì•ˆì—ë„ UIë¥¼ ë Œë”ë§ í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ì ì ˆí•œ í”¼ë“œë°±ì„ ì¤„ ìˆ˜ ìˆë‹¤.

íŠ¹íˆ ì»´í¬ë„ŒíŠ¸ë¥¼ ì„ ì–¸ì ìœ¼ë¡œ ë Œë”ë§ í•  ìˆ˜ ìˆë‹¤ëŠ” íŠ¹ì§•ì´ ìˆëŠ”ë° ì—¬ê¸°ê¹Œì§€ ë³´ë©´ Suspenseê°€ ì—†ì–´ë„ `isLoading`ì´ë‚˜ `isSuccess` ê°™ì€ ìƒíƒœ ë³€ìˆ˜ë¥¼ ì˜ í™œìš©í•˜ë©´ í•´ê²°í•  ìˆ˜ ìˆì§€ ì•Šë‚˜?ë¼ëŠ” ìƒê°ì´ ë“ ë‹¤.

í•˜ì§€ë§Œ ì—¬ëŸ¬ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ê²½ìš°ì—ëŠ” ì–´ë–¨ê¹Œ?

ì•„ë˜ ì½”ë“œì™€ ì‚¬ì§„ì€ ë¦¬íŒ©í„°ë§ì„ í•˜ê¸° ì „ Profile ì»´í¬ë„ŒíŠ¸ì¸ë°, ì»´í¬ë„ŒíŠ¸ì—ì„œ ì—¬ëŸ¬ `useQuery`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆì—ˆë‹¤.

```tsx
// ì¤‘ìš”í•˜ì§€ ì•Šì€ ì½”ë“œëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤.
const MyProfile = () => {
  const userProfileQuery = useMyProfileQuery();
  const bookshelfQuery = useMySummaryBookshlefQuery();
  const groupListQuery = useMyGroupsQuery();
  const { pathname } = useRouter();

  const isSuccess =
    userProfileQuery.isSuccess &&
    bookshelfQuery.isSuccess &&
    groupListQuery.isSuccess;

  const isLoading =
    userProfileQuery.isLoading &&
    bookshelfQuery.isLoading &&
    groupListQuery.isLoading;

  if (isLoading) {
    <Loaindg />;
  }

  if (isSuccess)
    return (
      <VStack>
        <ProfileInfo {...userProfileQuery.data} />
        <Button
          as={Link}
          href={`${pathname}/edit`}
          scheme="orange"
          fullWidth
          bgColor="main"
          color="white.900"
        >
          í”„ë¡œí•„ ìˆ˜ì •
        </Button>
        <ProfileBookshelf {...bookshelfQuery.data} />
        <ProfileGroup {...groupListQuery.data} />
      </VStack>
    );
};
```

![ê¸°ì¡´ í”„ë¡œí•„ í˜ì´ì§€](/post/20230419-fetching-data-declartively/profile-page.png)

**`1. ì‚¬ìš©ìì˜ í”„ë¡œí•„` `2. ì‚¬ìš©ìì˜ ì±…ì¥` `3. ì‚¬ìš©ìê°€ ì°¸ì—¬í•œ ëª¨ì„`** 3ê°œì˜ ë°ì´í„°ë¥¼ ëª¨ë‘ ë¶ˆëŸ¬ì™€ì•¼ ì»´í¬ë„ŒíŠ¸ê°€ ë Œë”ë§ ë  ìˆ˜ ìˆì—ˆê³ , í•˜ë‚˜ë¼ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•œë‹¤ë©´ ì»´í¬ë„ŒíŠ¸ ì „ì²´ê°€ ë Œë”ë§ ë˜ì§€ ì•ŠëŠ” ë¬¸ì œê°€ ìˆì—ˆë‹¤.

ëª¨ë“  ì—ëŸ¬ì— ëŒ€ì‘í•˜ì—¬ ì˜ˆì™¸ ì²˜ë¦¬ë¥¼ í•˜ë”ë¼ë„ ë§Œì•½ í”„ë¡œí•„ í˜ì´ì§€ì— ë³´ì—¬ì¤˜ì•¼ í•  ì •ë³´ê°€ ë” ìƒê¸´ë‹¤ë©´ ëª¨ë“  ê²½ìš°ì˜ ìˆ˜ë¥¼ ë˜ ë”°ì ¸ì„œ ëª…ë ¹í˜•ìœ¼ë¡œ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§ í•´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ìœ ì§€ ë³´ìˆ˜ê°€ ì–´ë µë‹¤ëŠ” ë¬¸ì œë„ ìˆì—ˆë‹¤.

Suspenseë¥¼ ì‚¬ìš©í•˜ë©´ ê´€ì‹¬ì‚¬ë¥¼ ë¶„ì‹œë¦¬ì¼œ ë‹¨ì¼ ì±…ì„ì˜ ì›ì¹™ë„ ë”°ë¥¼ ìˆ˜ ìˆì„ ê²ƒì´ë¼ íŒë‹¨í–ˆë‹¤.

## Container & Presentor

ë§¨ ì²˜ìŒì—ëŠ” ì¿¼ë¦¬ë¥¼ ìª¼ê°œì„œ ê°ê°ì˜ ì»´í¬ë„ŒíŠ¸ë¡œ ì˜®ê¸°ë©´ ë˜ëŠ” ê±° ì•„ë‹Œê°€? ì‹¶ì—ˆëŠ”ë° ë‹¤ë¥¸ ì‚¬ìš©ì í”„ë¡œí•„ì—ì„œëŠ” ë˜‘ê°™ì´ ë³´ì—¬ì£¼ëŠ”ë° ìˆ˜í–‰í•˜ëŠ” ì¿¼ë¦¬ê°€ ë‹¬ë¼ ì¬ì‚¬ìš©ì´ ì–´ë µë‹¤ëŠ” ë¬¸ì œê°€ ìˆì—ˆê³  (`/users/me` `/users/[userId]`), ì¿¼ë¦¬ì— ëŒ€í•œ ì˜ì¡´ì„±ì´ ë„ˆë¬´ ë†’ì•„ì§€ëŠ” ê²Œ ì‹«ì—ˆë‹¤.

ì§€ê¸ˆ ê°™ì€ ìƒí™©ì— í”„ë¡œì íŠ¸ ì´ˆê¸°ì— ë„ì…í•˜ë ¤ë‹¤ ì‹¤íŒ¨í•œ `Container & Presentor` íŒ¨í„´ì„ ë„ì…í•œë‹¤ë©´ ì ì ˆí•  ê²ƒ ê°™ë‹¤ê³  ìƒê°í–ˆë‹¤.

ê¸°ì¡´ ProfileInfo ì»´í¬ë„ŒíŠ¸ëŠ” ì „ë‹¬ë°›ì€ Propsë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë Œë”ë§ í•˜ëŠ” ì—­í• ë§Œ ìˆ˜í–‰í–ˆê¸° ë•Œë¬¸ì— Presentorë¡œ ì´ë¦„ë§Œ ë°”ê¿”ì£¼ì—ˆë‹¤.

```tsx
// ì¤‘ìš”í•˜ì§€ ì•Šì€ ì½”ë“œëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤.
const ProfileInfoPresentor = ({
  nickname,
  oauthNickname,
  profileImage,
  email,
  job: { jobGroupKoreanName, jobNameKoreanName },
}: ProfileInfoProps) => {
  return (
    <VStack>
      <Flex>
        <Avatar src={profileImage} />
        <VStack>
          <Text>{nickname || oauthNickname}</Text>
          <Text>{email}</Text>
        </VStack>
      </Flex>
      <HStack>
        <IconButton />
        <Text>
          {jobGroupKoreanName} / {jobNameKoreanName}
        </Text>
      </HStack>
    </VStack>
  );
};
```

ê·¸ë¦¬ê³ , ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í”„ë¡œí•„ì„ ì¡°íšŒí•˜ëŠ” 2ê°œì˜ Containerë¥¼ ë§Œë“¤ì—ˆë‹¤.

```tsx
// ì¤‘ìš”í•˜ì§€ ì•Šì€ ì½”ë“œëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤.
const MyProfileContainer = () => {
  const { isSuccess, data } = useMyProfileQuery({ suspense: true });

  useEffect(() => {
    if (!isSuccess) return;
    // ë‚´ í”„ë¡œí•„ì— íŠ¹ì • ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°ì— ìˆ˜í–‰ë˜ëŠ” ë¡œì§
  }, [isSuccess]);

  if (!isSuccess) return null;

  return <ProfileInfoPresenter {...data}></ProfileInfoPresenter>;
};
```

```tsx
// ì¤‘ìš”í•˜ì§€ ì•Šì€ ì½”ë“œëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤.
const UserProfileInfoContainer = ({
  userId,
}: {
  userId: APIUser["userId"];
}) => {
  const { isSuccess, data } = useUserProfileQuery(userId, { suspense: true });

  if (!isSuccess) return null;

  return <ProfileInfoPresenter {...data}></ProfileInfoPresenter>;
};
```

## Suspenseë¥¼ ì´ìš©í•œ ë¡œë”© ì²˜ë¦¬ ë¶„ë¦¬

ë‹¤ìŒì€ Promiseê°€ ì²˜ë¦¬ë˜ëŠ” ë™ì•ˆ ë³´ì—¬ì¤„ fallback ì»´í¬ë„ŒíŠ¸ë¥¼ ì‘ì„±í–ˆë‹¤.

```tsx
const ProfileInfoSkelenton = () => {
  return (
    <VStack>
      <SkeletonCircle />
      <Skeleton />
    </VStack>
  );
};
```

ê·¸ë¦¬ê³ , Suspenseë¡œ Containerë¥¼ ê°ìŒŒë‹¤. ì‚¬ìš©í•˜ê³  ìˆëŠ” React-Queryê°€ ì•„ì§ SSRì„ ì™„ë²½í•˜ê²Œ ì§€ì›í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì¸ ê²½ìš°ì—ë§Œ ì¿¼ë¦¬ë¥¼ ìˆ˜í–‰í•˜ë„ë¡ êµ¬í˜„í–ˆë‹¤.

ë§Œì•½ ì´ëŸ° ë¡œì§ì´ ì—†ë‹¤ë©´ Next.js ì„œë²„ì—ì„œ fetchë¥¼ ì‹œë„í•˜ê²Œ ë˜ëŠ”ë°, ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ì˜ axios ì„¤ì •ì´ ë‹¬ë¼ ë¬¸ì œê°€ ë˜ì—ˆë‹¤.

ê·¸ë ‡ë‹¤ê³  suspesnse ì˜µì…˜ì„ í™œì„±í™”í•˜ë©´ ë¬´ì‘ì • Next.js ì„œë²„ì—ì„œ fetchë¥¼ ì‹œë„í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆê³ , ì²« ë¡œë”©ì´ ì•„ë‹Œ ì¡°ê±´ë¶€ë¡œ ë Œë”ë§ ë˜ëŠ” ì»´í¬ë„ŒíŠ¸ì—ì„œëŠ” ì˜ ì‘ë™ëœë‹¤.

ê²½ìš°ì— ë”°ë¼ì„œ ë˜ê¸°ë„ í•˜ê³  ì•ˆë˜ê¸°ë„ í•´ì„œ ì´ ë¶€ë¶„ì—ì„œ ì‹œê°„ì„ ë§ì´ ì†Œìš”í•œ ê²ƒ ê°™ë‹¤. ğŸ˜‡

```tsx
// ì¤‘ìš”í•˜ì§€ ì•Šì€ ì½”ë“œëŠ” ìƒëµí–ˆìŠµë‹ˆë‹¤.
import { Suspense } from "react";

const ProfileInfo = ({ userId, children }: ProfileInfoProps) => {
  const mounted = useMounted();

  if (!mounted) return null;

  return (
    <Suspense fallback={<ProfileInfoSkelenton />}>
      {userId === "me" ? (
        <MyProfileContainer />
      ) : (
        <UserProfileInfoContainer userId={userId} />
      )}
      {children && children}
    </Suspense>
  );
};
```

## ErrorBoundaryë¥¼ ì´ìš©í•œ ì—ëŸ¬ ì²˜ë¦¬ ë¶„ë¦¬

ErrorBoundaryë¥¼ ì´ìš©í•˜ë©´ ë§Œì•½ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•˜ëŠ” ê²½ìš°ì— ì—ëŸ¬ì²˜ë¦¬ë¥¼ ì„ ì–¸ì ìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

react-queryë¥¼ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´ [QueryErrorResetBoundary](https://tanstack.com/query/v4/docs/react/reference/QueryErrorResetBoundary)ì™€ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ ì‹¤íŒ¨í•œ ì¿¼ë¦¬ë¥¼ ì‰½ê²Œ ë‹¤ì‹œ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

```tsx
import { Suspense } from "react";
import { QueryErrorResetBoundary } from "@tanstack/react-query";
import { ErrorBoundary } from "react-error-boundary";

const ProfileInfo = ({ userId, children }: ProfileInfoProps) => {
  const mounted = useMounted();

  if (!mounted) return null;

  return (
    <QueryErrorResetBoundary>
      {({ reset }) => (
        <ErrorBoundary
          onReset={reset}
          fallbackRender={({ resetErrorBoundary }) => (
            <QueryErrorBounaryFallback
              resetErrorBoundary={resetErrorBoundary}
            />
          )}
        >
          <Suspense fallback={<ProfileInfoSkelenton />}>
            {userId === "me" ? (
              <MyProfileContainer />
            ) : (
              <UserProfileInfoContainer userId={userId} />
            )}
            {children && children}
          </Suspense>
        </ErrorBoundary>
      )}
    </QueryErrorResetBoundary>
  );
};
```

## ë§ˆë¬´ë¦¬

Suspenseì™€ ErrorBoundaryë¥¼ ì´ìš©í•´ ì»´í¬ë„ŒíŠ¸ì˜ ì—­í• ì„ ëª…í™•í•˜ê²Œ ë¶„ë¦¬í•˜ê³  ê²°í•©ë„ë¥¼ ë‚®ì¶œ ìˆ˜ ìˆì—ˆë‹¤.

![ë¦¬íŒ©í„°ë§í•œ í”„ë¡œí•„ í˜ì´ì§€](/post/20230419-fetching-data-declartively/result.gif)

Suspenseë¥¼ ë¹„ë™ê¸°ë¡œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì— ì ìš©í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ì ì¬ì ì†Œì— ì˜ í™œìš©í•˜ëŠ”ê²Œ ì¢‹ì„ ê²ƒ ê°™ë‹¤. ì—¬ëŸ¬ ë°ì´í„°ë¥¼ ë™ì‹œì— ë¶ˆëŸ¬ì˜¤ê±°ë‚˜, ê²°í•©ë„ë¥¼ ë‚®ì¶”ê³  ì‹¶ì„ ë•Œ, ë³µì¡ë„ë¥¼ ë‚®ì¶”ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•˜ë©´ ì¢‹ì€ ê²°ê³¼ë¥¼ ë‚¼ ìˆ˜ ìˆì„ ê²ƒ ê°™ë‹¤.

<details >
<summary>ê·¸ë¦¬ê³ , ìë£Œë¥¼ ì°¾ì•„ë³´ë‹ˆ ë‚´ê°€ ì ìš©í•œ ë°©ë²• ì™¸ì—ë„ ë‹¤ì–‘í•˜ê²Œ Suspenseë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê²ƒ ê°™ë‹¤.</summary>

Next.jsì—ì„œ ì œê³µí•˜ëŠ” [Dynamic Import](https://nextjs.org/docs/advanced-features/dynamic-import)ì—ëŠ” `React.lazy`ì™€ `Suspense`ë¥¼ í¬í•¨í•˜ê³  ìˆê³ , dynamicì„ ì‚¬ìš©í•˜ë©´ ì»´í¬ë„ŒíŠ¸ê°€ ì´ˆê¸° ìë°”ìŠ¤í¬ë¦½íŠ¸ ë²ˆë“¤ì— í¬í•¨ë˜ì§€ ì•Šê³ , fallbackì„ ë¨¼ì € ë Œë”ë§ í•œ ë’¤ì— ëª¨ë“  ì²˜ë¦¬ê°€ ì™„ë£Œë˜ë©´ dynamic ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¨ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§ í•  ìˆ˜ ìˆëŠ” ê²ƒ ê°™ë‹¤.

Next.js 13ì˜ `app/` ë””ë ‰í„°ë¦¬ì—ì„œëŠ” [Streaming SSR](https://nextjs.org/docs/advanced-features/react-18/streaming)ì„ ì´ìš©í•´ ê¸°ë³¸ì ìœ¼ë¡œ HTMLì„ ìŠ¤íŠ¸ë¦¬ë°í•˜ëŠ”ë°, Suspenseì™€ í•¨ê»˜ ì‚¬ìš©í•˜ì—¬ fallback ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆëŠ” ê²ƒ ê°™ë‹¤.

</details>
